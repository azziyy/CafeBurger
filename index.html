<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 888 Platinum</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --------------------------------------------------
           1. PROFESSIONAL DIZAYN (VARIABLES & ANIMATIONS)
           -------------------------------------------------- */
        :root {
            --gold: #FFC107;      /* Asosiy rang */
            --dark: #1e1e24;      /* Fon rangi */
            --card: #2b2b36;      /* Karta foni */
            --text: #ffffff;      /* Yozuv rangi */
            --glass: rgba(43, 43, 54, 0.9); /* Shisha effekti */
            --radius: 20px;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* Animatsiyalar */
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--dark); color: var(--text);
            margin: 0; padding: 0; padding-bottom: 90px;
            overflow-x: hidden;
        }

        /* --------------------------------------------------
           2. HEADER & STORIES
           -------------------------------------------------- */
        .header {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: var(--glass); backdrop-filter: blur(15px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .logo { font-size: 24px; font-weight: 900; letter-spacing: 1px; }
        .logo span { color: var(--gold); }
        .icon-btn { font-size: 22px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; }
        .icon-btn:active { background: rgba(255,255,255,0.1); transform: scale(0.9); }

        /* STORIES */
        .stories-wrap {
            margin-top: 80px; padding: 10px 0 20px 0; overflow-x: auto; display: flex; gap: 15px; padding-left: 15px; scrollbar-width: none;
        }
        .story-circle {
            min-width: 70px; height: 70px; border-radius: 50%;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            padding: 3px; cursor: pointer; animation: fadeIn 1s ease;
        }
        .story-circle img {
            width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--dark); object-fit: cover;
        }
        
        /* --------------------------------------------------
           3. MENYU VA KARTALAR
           -------------------------------------------------- */
        .cat-nav {
            display: flex; gap: 10px; overflow-x: auto; padding: 0 15px 15px 15px; position: sticky; top: 70px; z-index: 900; background: var(--dark);
        }
        .cat-btn {
            padding: 10px 25px; border-radius: 30px; background: var(--card); color: #aaa;
            border: 1px solid rgba(255,255,255,0.05); font-weight: bold; transition: 0.3s;
        }
        .cat-btn.active { background: var(--gold); color: #000; border-color: var(--gold); transform: scale(1.05); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 15px; }
        .card {
            background: var(--card); border-radius: var(--radius); overflow: hidden;
            display: flex; flex-direction: column; box-shadow: var(--shadow);
            animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.97); }
        .card img { width: 100%; height: 150px; object-fit: cover; }
        .card-body { padding: 15px; display: flex; flex-direction: column; flex-grow: 1; }
        .card-title { font-size: 15px; font-weight: bold; margin-bottom: 5px; }
        .card-price { color: var(--gold); font-weight: 900; font-size: 16px; margin-bottom: 10px; }
        
        .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: auto; }
        .btn-add { background: rgba(255,255,255,0.1); color: white; }
        .btn-primary { background: var(--gold); color: black; box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3); }

        /* --------------------------------------------------
           4. MODALLAR (BLOCKED, CART, PROFILE)
           -------------------------------------------------- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 5000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; }
        
        .modal-box {
            background: var(--card); width: 85%; padding: 30px; border-radius: 25px;
            text-align: center; border: 1px solid rgba(255,255,255,0.1);
            transform: scale(0.8); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.active .modal-box { transform: scale(1); }

        /* BLOKLANISH EKRANI (QIZIL) */
        .blocked-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a0000; z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px;
        }
        .blocked-icon { font-size: 80px; color: #ff4757; margin-bottom: 20px; animation: pulse 2s infinite; }

        /* NAVBAR */
        .navbar {
            position: fixed; bottom: 0; width: 100%; height: 80px;
            background: var(--card); display: flex; justify-content: space-around;
            align-items: center; border-radius: 30px 30px 0 0; z-index: 2000;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #666; font-size: 11px; transition: 0.3s; }
        .nav-item.active { color: var(--gold); transform: translateY(-5px); }
        .nav-item i { font-size: 24px; margin-bottom: 5px; }

        /* STORIES VIEWER */
        .story-viewer { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:6000; display:none; }
        .story-img { width: 100%; height: 100%; object-fit: contain; }
        .progress-bar { position: absolute; top: 10px; width: 95%; left: 2.5%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; display:flex; gap:5px; }
        .progress-fill { height: 100%; background: #fff; border-radius: 2px; flex:1; }

        /* INPUTS */
        .inp { width: 100%; padding: 15px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 12px; color: white; margin-bottom: 15px; font-size: 16px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="blockedScreen" class="blocked-screen">
        <div class="blocked-icon"><i class="fa fa-ban"></i></div>
        <h1 style="color:#ff4757; margin-bottom:10px;">BLOKLANGAN!</h1>
        <p style="color:#ccc; line-height:1.6;">Hurmatli foydalanuvchi, sizning raqamingiz tizim qoidalarini buzgani uchun <b>Qora Ro'yxat</b>ga kiritildi.</p>
        <p style="color:#666; font-size:12px; margin-top:30px;">ID: <span id="blockID"></span></p>
    </div>

    <header class="header">
        <div class="icon-btn" onclick="toggleDrawer()"><i class="fa fa-bars"></i></div>
        <div class="logo">CAFE <span>888</span></div>
        <div class="icon-btn" onclick="openProfile()"><i class="fa fa-user"></i></div>
    </header>

    <div id="storiesWrap" class="stories-wrap hidden">
        </div>

    <div id="p-menu" class="page">
        <div id="catNav" class="cat-nav"></div>
        <div id="menuGrid" class="grid"></div>
    </div>

    <div id="p-cart" class="page hidden">
        <h2 style="padding:0 20px;">Savatcha</h2>
        <div id="cartList" style="padding:0 20px 150px 20px;"></div>
        
        <div style="position:fixed; bottom:90px; left:15px; right:15px; background:var(--card); padding:20px; border-radius:20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.05);">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:18px; font-weight:bold;">
                <span>Jami:</span> <span id="totalPrice" style="color:var(--gold)">0 so'm</span>
            </div>
            <button id="locBtn" class="btn" style="background:rgba(255,255,255,0.05); color:#aaa; margin-bottom:10px; border:1px dashed #555;" onclick="getLocation()">
                <i class="fa fa-location-arrow"></i> Manzilni aniqlash
            </button>
            <button id="orderBtn" class="btn" style="background:#444; color:#777; pointer-events:none;" onclick="sendOrder()">
                BUYURTMA BERISH
            </button>
        </div>
    </div>

    <div id="p-orders" class="page hidden">
        <h2 style="padding:0 20px;">Buyurtmalar tarixi</h2>
        <div id="historyList" style="padding:0 20px;"></div>
    </div>

    <div id="storyViewer" class="story-viewer" onclick="closeStories()">
        <div id="storyProgress" class="progress-bar"></div>
        <img id="storyImgFull" class="story-img">
    </div>

    <nav class="navbar">
        <div class="nav-item active" onclick="nav('menu', this)"><i class="fa fa-utensils"></i> Menyu</div>
        <div class="nav-item" onclick="nav('cart', this)"><i class="fa fa-shopping-basket"></i> Savat</div>
        <div class="nav-item" onclick="nav('orders', this)"><i class="fa fa-history"></i> Tarix</div>
    </nav>

    <div id="alertModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="alertTitle" style="margin-top:0">Xabar</h3>
            <p id="alertMsg" style="color:#ccc; margin-bottom:20px;"></p>
            <button class="btn btn-primary" onclick="closeAlert()">Tushunarli</button>
        </div>
    </div>

    <div id="profModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Ro'yxatdan o'tish</h3>
            <p style="color:#888; font-size:12px; margin-bottom:20px;">Buyurtma berish uchun ma'lumotlaringizni kiriting</p>
            <input id="profName" class="inp" placeholder="Ismingiz">
            <input id="profPhone" class="inp" type="tel" value="+998">
            <button class="btn btn-primary" onclick="saveProfile()">SAQLASH</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCVSfWRZ77PFFxip93NcD5QZ9Fc0gMUyW8",
            authDomain: "cafe888-c2d7d.firebaseapp.com",
            databaseURL: "https://cafe888-c2d7d-default-rtdb.firebaseio.com",
            projectId: "cafe888-c2d7d",
            storageBucket: "cafe888-c2d7d.firebasestorage.app",
            messagingSenderId: "286769489924",
            appId: "1:286769489924:web:f778a8d15d46abaf1b2d51"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // SIZNING JADVALLARINGIZ
        const MENU_SHEET = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk";
        const ADS_SHEET = "1ENQ4bnzBxj7x5jmrXUwdDZhmEMQ7umPTPwq2bgXfj3k";

        let products=[], cart={}, user=null, loc=null;
        let adsList=[], adIdx=0, adTimer;

        function init() {
            // 1. Profil va Bloklashni tekshirish
            const savedPhone = localStorage.getItem('cafe_phone');
            if(savedPhone) {
                checkUserStatus(savedPhone);
            } else {
                openProfile();
            }

            // 2. Input formatlash
            document.getElementById('profPhone').addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g,'');
                if(!v.startsWith('998')) v='998'+v;
                e.target.value = '+'+v.substring(0,12);
            });

            // 3. Ma'lumotlarni yuklash
            loadMenu();
            loadAds();
        }

        // --- USER & BLOCKING SYSTEM ---
        function checkUserStatus(phone) {
            db.ref('users/'+phone).on('value', snap => {
                const val = snap.val();
                
                // AGAR BLOKLANGAN BO'LSA
                if(val && val.blocked === true) {
                    document.getElementById('blockID').innerText = phone;
                    document.getElementById('blockedScreen').style.display = 'flex'; // Qutulib bo'lmas oyna
                    localStorage.removeItem('cafe_phone'); // Sessiyani o'chirish
                    return; // Dasturni to'xtatish
                }
                
                // Agar hammasi joyida bo'lsa
                if(val) {
                    user = val;
                    localStorage.setItem('cafe_phone', phone);
                    document.getElementById('blockedScreen').style.display = 'none'; // Blokni olish (agar ochilgan bo'lsa)
                    loadHistory();
                } else {
                    openProfile();
                }
            });
        }

        function saveProfile() {
            const name = document.getElementById('profName').value;
            const phone = document.getElementById('profPhone').value.replace(/\D/g,'');
            if(name.length<3 || phone.length<12) return showAlert("Xatolik", "Ism va raqamni to'g'ri kiriting");

            const newUser = { name, phone, blocked: false };
            
            // Avval bloklanganligini tekshiramiz
            db.ref('users/'+phone).once('value', s => {
                if(s.val() && s.val().blocked) {
                    checkUserStatus(phone); // Blok oynasini chiqaradi
                } else {
                    db.ref('users/'+phone).set(newUser);
                    user = newUser;
                    localStorage.setItem('cafe_phone', phone);
                    document.getElementById('profModal').classList.remove('active');
                    setTimeout(()=>document.getElementById('profModal').style.display='none',300);
                    showAlert("Xush kelibsiz", `Salom, ${name}!`);
                }
            });
        }

        // --- STORIES (REKLAMA) ---
        function loadAds() {
            const s = document.createElement('script');
            s.src = `https://docs.google.com/spreadsheets/d/${ADS_SHEET}/gviz/tq?tqx=responseHandler:handleAds`;
            document.body.appendChild(s);
        }
        window.handleAds = json => {
            const rows = json.table.rows.map(r => r.c[0]?.v).filter(u => u);
            adsList = rows;
            
            if(adsList.length > 0) {
                document.getElementById('storiesWrap').classList.remove('hidden');
                document.getElementById('storiesWrap').innerHTML = adsList.map((u, i) => `
                    <div class="story-circle" onclick="openStory(${i})">
                        <img src="${u}">
                    </div>
                `).join('');
            }
        }
        function openStory(i) {
            adIdx = i;
            document.getElementById('storyViewer').style.display = 'block';
            showStoryImg();
        }
        function showStoryImg() {
            if(adIdx >= adsList.length) { closeStories(); return; }
            document.getElementById('storyImgFull').src = adsList[adIdx];
            
            // Progress
            const bar = document.getElementById('storyProgress');
            bar.innerHTML = adsList.map((_, idx) => 
                `<div class="progress-fill" style="background:${idx < adIdx ? '#fff' : (idx==adIdx?'#fff':'rgba(255,255,255,0.3)')}; width:${idx==adIdx?'0%':'100%'}"></div>`
            ).join('');
            
            // Animatsiya
            setTimeout(() => {
                const activeFill = document.querySelectorAll('.progress-fill')[adIdx];
                if(activeFill) {
                    activeFill.style.transition = 'width 5s linear';
                    activeFill.style.width = '100%';
                }
            }, 50);

            clearTimeout(adTimer);
            adTimer = setTimeout(() => { adIdx++; showStoryImg(); }, 5000);
        }
        function closeStories() { clearTimeout(adTimer); document.getElementById('storyViewer').style.display = 'none'; }

        // --- MENU & CART ---
        function loadMenu() {
            const s = document.createElement('script');
            s.src = `https://docs.google.com/spreadsheets/d/${MENU_SHEET}/gviz/tq?tqx=responseHandler:handleMenu`;
            document.body.appendChild(s);
        }
        window.handleMenu = json => {
            products = json.table.rows.map(r => ({
                id: r.c[0]?.v, cat: r.c[1]?.v||"Boshqa", name: r.c[2]?.v, 
                price: r.c[3]?.v||0, img: r.c[4]?.v
            }));
            renderCats(); renderGrid('Barchasi');
        }
        function renderCats() {
            const cats = ['Barchasi', ...new Set(products.map(p=>p.cat))];
            document.getElementById('catNav').innerHTML = cats.map(c => `
                <button class="cat-btn ${c==='Barchasi'?'active':''}" onclick="filter('${c}', this)">${c}</button>
            `).join('');
        }
        function filter(c, el) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            renderGrid(c);
        }
        function renderGrid(c) {
            const list = c==='Barchasi' ? products : products.filter(p=>p.cat===c);
            document.getElementById('menuGrid').innerHTML = list.map(p => {
                const q = cart[p.id] || 0;
                const btn = q===0 
                    ? `<button class="btn btn-add" onclick="upd(${p.id}, 1)">Savatga</button>`
                    : `<div style="display:flex; justify-content:space-between; align-items:center; background:var(--gold); border-radius:10px; padding:8px;">
                        <i class="fa fa-minus" onclick="upd(${p.id}, -1)" style="color:black; width:30px; text-align:center;"></i>
                        <span style="font-weight:bold; color:black;">${q}</span>
                        <i class="fa fa-plus" onclick="upd(${p.id}, 1)" style="color:black; width:30px; text-align:center;"></i>
                       </div>`;
                return `
                <div class="card">
                    <img src="${p.img}" onerror="this.src='https://via.placeholder.com/200'">
                    <div class="card-body">
                        <div class="card-title">${p.name}</div>
                        <div class="card-price">${p.price.toLocaleString()} so'm</div>
                        ${btn}
                    </div>
                </div>`;
            }).join('');
        }

        function upd(id, n) {
            cart[id] = (cart[id] || 0) + n;
            if(cart[id] <= 0) delete cart[id];
            
            const active = document.querySelector('.cat-btn.active')?.innerText || 'Barchasi';
            if(!document.getElementById('p-menu').classList.contains('hidden')) renderGrid(active);
            if(!document.getElementById('p-cart').classList.contains('hidden')) renderCart();
        }

        function renderCart() {
            let t = 0, h = '';
            for(let id in cart) {
                const p = products.find(x => x.id == id);
                t += p.price * cart[id];
                h += `
                <div style="background:var(--card); padding:15px; border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${p.name}</div>
                        <div style="font-size:12px; color:#888;">${p.price} x ${cart[id]}</div>
                    </div>
                    <div style="font-weight:bold; color:var(--gold);">${(p.price*cart[id]).toLocaleString()}</div>
                    <div style="background:#444; border-radius:10px; padding:5px 10px; display:flex; gap:10px;">
                        <span onclick="upd(${p.id}, -1)">-</span>
                        <b>${cart[id]}</b>
                        <span onclick="upd(${p.id}, 1)">+</span>
                    </div>
                </div>`;
            }
            document.getElementById('cartList').innerHTML = h || "<div style='text-align:center; margin-top:50px; color:#666'>Savat bo'sh</div>";
            document.getElementById('totalPrice').innerText = t.toLocaleString() + " so'm";
            
            const btn = document.getElementById('orderBtn');
            if(t > 0 && loc) { btn.style.background = "var(--gold)"; btn.style.color = "black"; btn.style.pointerEvents = "all"; }
            else { btn.style.background = "#444"; btn.style.color = "#777"; btn.style.pointerEvents = "none"; }
        }

        function getLocation() {
            const btn = document.getElementById('locBtn');
            btn.innerHTML = "<i class='fa fa-spinner fa-spin'></i> Aniqlanmoqda...";
            navigator.geolocation.getCurrentPosition(p => {
                loc = { lat: p.coords.latitude, long: p.coords.longitude };
                btn.innerHTML = "<i class='fa fa-check'></i> Manzil olindi";
                btn.style.borderColor = "var(--gold)"; btn.style.color = "var(--gold)";
                renderCart();
            }, () => { showAlert("Xato", "GPS yoqilmadi!"); btn.innerHTML = "Qayta urinish"; });
        }

        function sendOrder() {
            const items = []; let total = 0;
            for(let id in cart) {
                const p = products.find(x => x.id == id);
                items.push({name: p.name, qty: cart[id]});
                total += p.price * cart[id];
            }
            db.ref('orders').push({
                user_id: user.phone, user_info: `${user.name} (${user.phone})`,
                items, total, location: loc, status: 'yangi', time: new Date().toLocaleString()
            });
            showAlert("Qabul qilindi", "Buyurtmangiz yuborildi. Tez orada aloqaga chiqamiz!");
            cart = {}; loc = null;
            document.getElementById('locBtn').innerHTML = "Manzilni aniqlash";
            renderCart();
            nav('orders', document.querySelectorAll('.nav-item')[2]);
        }

        function loadHistory() {
            db.ref('orders').limitToLast(20).on('value', snap => {
                const data = snap.val();
                if(!data) { document.getElementById('historyList').innerHTML = "<div style='text-align:center; margin-top:50px; color:#666'>Tarix bo'sh</div>"; return; }
                
                const myOrders = Object.values(data).filter(o => o.user_id == user.phone).reverse();
                document.getElementById('historyList').innerHTML = myOrders.map(o => `
                    <div style="background:var(--card); padding:20px; border-radius:20px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.05);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span style="background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:8px; font-size:12px; font-weight:bold;">${o.status.toUpperCase()}</span>
                            <span style="color:#666; font-size:12px;">${o.time.split(',')[0]}</span>
                        </div>
                        <div style="color:#ccc; margin-bottom:10px; font-size:14px;">${o.items.map(i=>`${i.name} x${i.qty}`).join(', ')}</div>
                        <div style="font-weight:900; color:var(--gold); font-size:18px;">${o.total.toLocaleString()} so'm</div>
                    </div>
                `).join('');
            });
        }

        // UTILS
        function nav(page, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('p-'+page).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(page==='cart') renderCart();
        }
        function toggleDrawer() { /* Drawer kodi soddalashtirildi, zarurat bo'lsa qo'shiladi */ }
        function showAlert(t, m) {
            document.getElementById('alertTitle').innerText = t;
            document.getElementById('alertMsg').innerText = m;
            const o = document.getElementById('alertModal');
            o.style.display = 'flex'; setTimeout(()=>o.classList.add('active'), 10);
        }
        function closeAlert() {
            const o = document.getElementById('alertModal');
            o.classList.remove('active'); setTimeout(()=>o.style.display='none', 300);
        }
        function openProfile() {
            const o = document.getElementById('profModal');
            o.style.display = 'flex'; setTimeout(()=>o.classList.add('active'), 10);
        }

        window.onload = init;
    </script>
</body>
</html>